var map,
  datasource,
  client,
  popup,
  searchInput,
  resultsPanel,
  searchInputLength,
  centerMapOnResults,
  minSearchInputLength = 3,
  keyStrokeDelay = 150;
function GetMap() {
  (map = new atlas.Map("myMap", {
    center: [-118.270293, 34.039737],
    zoom: 14,
    view: "Auto",
    authOptions: {
      authType: "subscriptionKey",
      subscriptionKey: "jphGVAbly1ZAmDCcsyX-q6K263wJWmThhBkue0xJYow",
    },
  })),
    (resultsPanel = document.getElementById("results-panel")),
    (searchInput = document.getElementById("search-input")).addEventListener(
      "keyup",
      searchInputKeyup
    ),
    (popup = new atlas.Popup()),
    map.events.add("ready", function () {
      map.controls.add(new atlas.control.ZoomControl(), {
        position: "top-right",
      }),
        (datasource = new atlas.source.DataSource()),
        map.sources.add(datasource);
      var searchLayer = new atlas.layer.SymbolLayer(datasource, null, {
        iconOptions: {
          image: "pin-round-darkblue",
          anchor: "center",
          allowOverlap: !0,
        },
      });
      map.layers.add(searchLayer),
        map.events.add("click", searchLayer, function (e) {
          e.shapes && e.shapes.length > 0 && showPopup(e.shapes[0]);
        });
    });
}
function searchInputKeyup(e) {
  (centerMapOnResults = !1),
    searchInput.value.length >= minSearchInputLength
      ? (13 === e.keyCode && (centerMapOnResults = !0),
        setTimeout(function () {
          searchInputLength == searchInput.value.length && search();
        }, keyStrokeDelay))
      : (resultsPanel.innerHTML = ""),
    (searchInputLength = searchInput.value.length);
}
function search() {
  datasource.clear(), popup.close(), (resultsPanel.innerHTML = "");
  var subscriptionKeyCredential = new atlas.service.SubscriptionKeyCredential(
      atlas.getSubscriptionKey()
    ),
    pipeline = atlas.service.MapsURL.newPipeline(subscriptionKeyCredential),
    searchURL = new atlas.service.SearchURL(pipeline),
    query = document.getElementById("search-input").value;
  searchURL
    .searchPOI(atlas.service.Aborter.timeout(1e4), query, {
      lon: map.getCamera().center[0],
      lat: map.getCamera().center[1],
      maxFuzzyLevel: 4,
      view: "Auto",
    })
    .then((results) => {
      var data = results.geojson.getFeatures();
      datasource.add(data),
        centerMapOnResults && map.setCamera({ bounds: data.bbox }),
        console.log(data);
      for (var html = [], i = 0; i < data.features.length; i++) {
        var r = data.features[i];
        html.push(
          "<li onclick=\"itemClicked('",
          r.id,
          "')\" onmouseover=\"itemHovered('",
          r.id,
          "')\">"
        ),
          html.push('<div class="title">'),
          r.properties.poi && r.properties.poi.name
            ? html.push(r.properties.poi.name)
            : html.push(r.properties.address.freeformAddress),
          html.push(
            '</div><div class="info">',
            r.properties.type,
            ": ",
            r.properties.address.freeformAddress,
            "</div>"
          ),
          r.properties.poi &&
            (r.properties.phone &&
              html.push(
                '<div class="info">phone: ',
                r.properties.poi.phone,
                "</div>"
              ),
            r.properties.poi.url &&
              html.push(
                '<div class="info"><a href="http://',
                r.properties.poi.url,
                '">http://',
                r.properties.poi.url,
                "</a></div>"
              )),
          html.push("</li>"),
          (resultsPanel.innerHTML = html.join(""));
      }
    });
}
function itemHovered(id) {
  var shape;
  showPopup(datasource.getShapeById(id));
}
function itemClicked(id) {
  var shape = datasource.getShapeById(id);
  map.setCamera({ center: shape.getCoordinates(), zoom: 17 });
}
function showPopup(shape) {
  var properties = shape.getProperties(),
    html = ['<div class="poi-box">'];
  html.push('<div class="poi-title-box"><b>'),
    properties.poi && properties.poi.name
      ? html.push(properties.poi.name)
      : html.push(properties.address.freeformAddress),
    html.push("</b></div>"),
    html.push('<div class="poi-content-box">'),
    html.push(
      '<div class="info location">',
      properties.address.freeformAddress,
      "</div>"
    ),
    properties.poi &&
      (properties.poi.phone &&
        html.push('<div class="info phone">', properties.phone, "</div>"),
      properties.poi.url &&
        html.push(
          '<div><a class="info website" href="http://',
          properties.poi.url,
          '">http://',
          properties.poi.url,
          "</a></div>"
        )),
    html.push("</div></div>"),
    popup.setOptions({
      position: shape.getCoordinates(),
      content: html.join(""),
    }),
    popup.open(map);
}
